<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VEHAB</title>
    <style>
      /* -----------  BASIC LAYOUT  ----------- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 2rem;
        font-family: Arial, sans-serif;
        background: #ffffff;
        color: #222;
      }
      h1 {
        margin-top: 0;
      }

      /* -----------  TABS  ----------- */
      .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .tab-button {
        padding: 0.6rem 1.2rem;
        border: 1px solid #ccc;
        border-bottom: none;
        background: #ffae68;
        border-radius: 0.5rem 0.5rem 0 0;
        cursor: pointer;
        transition: background 0.2s;
        color: #222;
      }
      .tab-button:hover {
        background: #dcdcdc;
      }
      .tab-button.active {
        background: #ff661f;
        font-weight: 600;
      }
      .tab-content {
        border: 1px solid #ccc;
        border-radius: 0 0.5rem 0.5rem 0.5rem;
        background: #fff;
        padding: 1.25rem;
        min-height: 18rem;
      }
      .hidden {
        display: none !important;
      }

      /* -----------  SYMPTOM FORM  ----------- */
      textarea {
        width: 100%;
        max-width: 100%;
        min-height: 7rem;
        padding: 0.5rem;
        resize: vertical;
        border: 1px solid #ccc;
        border-radius: 0.25rem;
      }
      button {
        padding: 0.6rem 1rem;
        border: none;
        border-radius: 0.25rem;
        background: #3620ff;
        color: #fff;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: #214aff;
      }
      button.secondary {
        background: #6c757d;
      }
      button.secondary:hover {
        background: #5b636b;
      }
      button:disabled {
        background: #b6b6b6;
        cursor: not-allowed;
      }

      /* Styles for the file upload input (adjusted for inline use) */
      .file-upload-inline-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .file-upload-inline-container input[type="file"] {
        display: none;
      }
      .file-upload-inline-container .custom-file-upload {
        display: inline-block;
        padding: 0.6rem 1rem;
        border: none;
        border-radius: 0.25rem;
        background: #3620ff;
        color: #fff;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      .file-upload-inline-container .custom-file-upload:hover {
        background: #214aff;
      }
      .file-upload-inline-container .file-name {
          margin-left: 0.5rem;
          font-style: italic;
          color: #555;
          flex-grow: 1;
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
      }

      /* -----------  EXERCISE AREA  ----------- */
      .exercise-steps-container {
        margin-top: 1rem;
        padding: 1rem;
        border: 1px dashed #007bff;
        border-radius: 0.5rem;
        background: #f0f7ff;
      }
      .exercise-steps-container ul {
        padding-left: 1.2rem;
      }
      #webcam-container {
        margin-top: 1.5rem;
        text-align: center;
        border: 1px solid #eee;
        border-radius: 0.5rem;
        padding: 1rem;
        background: #fcfcfc;
      }
      #videoElement {
        width: 100%;
        max-width: 640px;
        aspect-ratio: 16/9;
        background: #000;
        border: 1px solid #aaa;
        border-radius: 0.25rem;
      }
      .vlm-feedback {
        margin-top: 0.8rem;
        padding: 0.8rem;
        border: 1px solid #dee2e6;
        background: #f9f9f9;
        border-radius: 0.25rem;
        text-align: left;
      }
      .vlm-status {
        font-weight: 600;
      }
      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.8rem;
      }
      .video-preview {
            margin: 20px 0;
            text-align: center;
      }
      .video-preview video {
          max-width: 100%;
          max-height: 300px;
          border-radius: 8px;
      }
      .feedback-section {
          margin-top: 30px;
          padding: 20px;
          background: #f8f9fa;
          border-radius: 8px;
          display: none;
      }
      .feedback-section.show {
          display: block;
      }
      /* Video analysis container */
      #video-analysis-container {
        display: none;
        margin-top: 2rem;
        padding: 1.5rem;
        border: 1px solid #ddd;
        border-radius: 0.5rem;
        background: #fff;
      }

      #video-analysis-container.show {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
      }

      .video-display {
        flex: 1;
        min-width: 0;
      }

      .video-display video {
        width: 100%;
        max-width: 400px;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .analysis-feedback {
        flex: 1;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #e9ecef;
      }

      .analysis-feedback h3 {
        margin-top: 0;
        color: #495057;
      }

      .analyzing-spinner {
        display: inline-block;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

    </style>
  </head>
  <body>
    <h1>VEHAB: Your AI Prosthetic Rehab Assistant</h1>

    <!--  TAB CONTROLS  -->
    <div class="tabs">
      <button class="tab-button active" data-target="exerciseTab">Exercise</button>
      <button class="tab-button" data-target="recommendTab">Get Recommendations</button>
    </div>

    <!--  EXERCISE TAB  -->
    <section id="exerciseTab" class="tab-content">
      <h2>Step-by-Step Exercises</h2>
      <p>Describe your prosthetic/amputation type to get tailored exercise recommendations:</p>
      <select id="prostheticInput">
        <option value="" disabled selected>Select prosthetic/amputation type</option>
        <option value="transtibial">Transtibial (below knee)</option>
        <option value="transfemoral">Transfemoral (above knee)</option>
      </select>
      <select id="legInput">
        <option value="" disabled selected>Select right or left leg</option>
        <option value="right">Right leg</option>
        <option value="left">Left leg</option>
      </select>
      <br />
      <p>List the exercises recommended to you by your physiotherapist:</p>
      <textarea id="exercisesInput" placeholder="e.g., Hamstring Stretch, Hip Extension on Side, Side Stepping."></textarea>
      <br />
      <div class="button-row">
        <button id="askButton">Get Recommendation</button>
        <br />
        <div class="file-upload-inline-container">
            <input type="file" name="pdf_file" id="inlinePdfFileInput" accept=".pdf">
            <label for="inlinePdfFileInput" class="custom-file-upload">Upload PDF</label>
            <span id="inlineFileNameDisplay" class="file-name">No file chosen</span>
        </div>

        <button id="cancelUploadBtn">Cancel Upload</button>    
      </div>

      <div class="exercise-navigation">
        <button id="prevExerciseButton" class="hidden">Previous Exercise</button>
        <span id="exerciseProgress" style="margin: 0 1rem;">Exercise 0 of 0</span>
        <button id="nextExerciseButton" class="hidden">Next Exercise</button>
      </div>

      <p id="inlineUploadStatus" style="margin-top: 0.5rem; font-weight: bold;"></p>

      <div id="recommendationResult" style="margin-top: 1rem;">
        <p><strong>Exercise:</strong> <span id="exerciseOutput">N/A</span></p>
        <p><strong>Prosthetic limb type:</strong> <span id="prostheticOutput">N/A</span></p>
        <p><strong>Exercise Purpose:</strong> <span id="purposeOutput">N/A</span></p>
        <p><strong>Common Mistakes:</strong> <span id="mistakesOutput">N/A</span></p>

        <div class="exercise-steps-container">
          <h4>Exercise Steps:</h4>

          <ul id="exerciseStepsList">
            <li>Steps will appear here.</li>
          </ul>

          <div class="speech-controls" style="margin-top: 1rem;">
            <label for="voiceSelect"><strong>Choose Voice:</strong></label>
            <select id="voiceSelect"></select>
          
            <div style="margin-top: 1rem;">
              <label for="rateSlider">Speed (Rate): <span id="rateValue">1</span></label>
              <input type="range" id="rateSlider" min="0.5" max="2" value="1" step="0.1" />
            </div>
          
            <div style="margin-top: 1rem;">
              <button id="readStepsButton" class="secondary">Read Steps</button>
              <button id="pauseButton" class="secondary">‚è∏ Pause</button>
              <button id="resumeButton" class="secondary">‚ñ∂ Resume</button>
              <button id="stopButton" class="secondary">‚èπ Stop</button>
            </div>
          </div>         

          <div class="button-group">
            <button id="startExerciseButton" class="hidden">Start Exercise with VLM</button>
            <button id="uploadVideoButton" class="hidden">Upload Video</button>
            <input type="file" id="videoFileInput" accept="video/*" style="display: none;">
            <button id="analyzeVideoButton" class="hidden">Analyze Video</button>
            <button id="nextStepButton" class="hidden secondary">Next Step</button>
            <button id="finishExerciseButton" class="hidden secondary">Finish Exercise</button>
          </div>
          <p id="videoUploadStatus" style="margin-top: 0.5rem; font-weight: bold; color: green;"></p>

          <div id="videoPreview" class="video-preview"></div>
        </div>

        <!-- Error messages can appear anytime -->
        <div id="errorMessage" class="error" style="display: none;"></div>
        
        <!-- Feedback section - only shows AFTER successful video analysis -->
        <div id="feedbackSection" class="feedback-section" style="display: none;">
          <h3>Exercise Analysis Results</h3>
          <div id="feedbackContent" class="feedback-content"></div>
        </div>
      </div>

      <div id="webcam-container" class="hidden">
        <h3>Exercise Supervision (Webcam)</h3>
        <video id="videoElement" autoplay muted playsinline></video>
        <div class="vlm-feedback">
          <h4>Current Step: <span id="currentStepDisplay">N/A</span></h4>
          <p id="vlmFeedbackOutput">Awaiting feedback...</p>
          <p class="vlm-status">Status: <span id="vlmStatusOutput">Idle</span></p>
        </div>
        <button id="stopWebcamButton" class="secondary">Stop Webcam</button>
      </div>

      <!-- Video Analysis Container -->
      <div id="video-analysis-container">
        <div class="video-display">
          <h3>Uploaded Video</h3>
          <video id="analysis-video" controls></video>
        </div>
        <div class="analysis-feedback">
          <h3>Analysis</h3>
          <div id="analysis-content">
            <span class="analyzing-spinner">‚ü≥</span> Analyzing video...
          </div>
        </div>
      </div>
      <p><strong>Source(s):</strong> <span id="stepSource">N/A</span></p>
    </section>


    <!--  SECOND TAB  -->
    <section id="recommendTab" class="tab-content hidden">
      <h2>Get Recommendations</h2>
      <p>Get basic exercises based on recovery timeline, skill, and prosthetic type</p>
    </section>

    <!--  SCRIPT AREA  -->
    <script>
      /********************************************
       * GLOBAL STATE
       *******************************************/
      const state = {
        stream: null,
        steps: [],
        currentStep: 0,
        frameIntervalId: null,
        processingFrames: false,
      };

      /********************************************
       * TAB CONTROL
       *******************************************/
      document.querySelectorAll('.tab-button').forEach((btn) => {
        btn.addEventListener('click', () => switchTab(btn.dataset.target, btn));
      });

      function switchTab(targetId, btn) {
        document.querySelectorAll('.tab-content').forEach((tab) => tab.classList.add('hidden'));
        document.getElementById(targetId).classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');

        stopWebcam();
      }

      /********************************************
      * MULTI-EXERCISE SUPPORT
      *******************************************/
      let exerciseQueue = [];
      let currentExerciseIndex = 0; 

      function toggle(id, shouldHide) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle('hidden', shouldHide);
      }
    
      function updateExerciseProgress() {
        const progress = document.getElementById('exerciseProgress');
        if (!progress) return;
        progress.textContent = `Exercise ${currentExerciseIndex + 1} of ${exerciseQueue.length}`;
      }     

      document.getElementById('askButton').addEventListener('click', async () => {
        const exercisesRaw = document.getElementById('exercisesInput').value.trim();
        if (!exercisesRaw) return alert('Please enter your exercises.');

        // split on commas AND/OR newlines
        exerciseQueue = exercisesRaw
          .split(/[\n,]+/)
          .map(ex => ex.trim())
          .filter(ex => ex.length > 0);
        
        if (!exerciseQueue.length) return alert('Please enter at least one valid exercise.');
    
        currentExerciseIndex = 0;
        await loadExercise(exerciseQueue[currentExerciseIndex]);

        toggle('prevExerciseButton', true);
        toggle('nextExerciseButton', exerciseQueue.length <= 1);
        updateExerciseProgress();
      });
      
      document.getElementById('nextExerciseButton').addEventListener('click', async () => {
        if (currentExerciseIndex + 1 < exerciseQueue.length) {
          currentExerciseIndex++;
          await loadExercise(exerciseQueue[currentExerciseIndex]);
          toggle('prevExerciseButton', false);
          toggle('nextExerciseButton', currentExerciseIndex + 1 >= exerciseQueue.length);
          updateExerciseProgress();
        }
      });
    
      document.getElementById('prevExerButton').addEventListener('click', async () => {
        if (currentExerciseIndex > 0) {
          currentExerciseIndex--;
          await loadExercise(exerciseQueue[currentExerciseIndex]);
          toggle('nextExerciseButton', false);
          toggle('prevExerciseButton', currentExerciseIndex === 0);
          updateExerciseProgress();
        }
      });

      async function loadExercise(exerciseName) {
        const prosthetic = document.getElementById('prostheticInput').value.trim();
        if (!prosthetic) return alert('Please enter your prosthetic type.');
    
        const leg = document.getElementById('legInput').value.trim();
        if (!leg) return alert('Please enter the leg side.');

        // reset UI
        resetUI();
        setText('exerciseOutput', 'Thinking...'); // change for demo day
        setText('prostheticOutput', 'Verifying...'); // change for demo day
        setText('purposeOutput', 'Analyzing...');
        setText('mistakesOutput', 'Reading...');
        setText('stepSource', 'Loading Source(s)...');

        try {
          const res = await fetch('/ask_llm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ exercises: exerciseName, prosthetic, leg })
          });
    
          const data = await res.json();
          if (data.error) throw new Error(data.error);

          setText('exerciseOutput', data.exercise ?? 'Unknown');
          setText('prostheticOutput', data.prosthetic ?? 'Unknown');
          setText('purposeOutput', data.purpose ?? 'Unknown');
          setText('mistakesOutput', data.mistake ?? 'Unknown');

          state.steps = data.steps ?? [];
          state.currentStep = 0;
          renderSteps();

          const sources = data.sources && data.sources.length > 0 ? data.sources.join(', ') : "Unknown";
          document.getElementById("stepSource").innerText = sources;

          toggle('startExerciseButton', false);
          toggle('uploadVideoButton', false);

        } catch (err) {
          console.error(err);
          setText('exerciseOutput', `Error: ${err.message}`);
          setText('prostheticOutput', '‚úñ');
          setText('purposeOutput', '‚úñ');
          setText('mistakesOutput', '‚úñ');

          document.getElementById('exerciseStepsList').innerHTML = '<li>Failed to load steps.</li>';

          document.getElementById("stepSource").innerText = "No sources available.";
        }
      }

      function updateNavigationControls() {
        // show progress 
        progressText.textContent = `Exercise ${currentExerciseIndex + 1} of ${exerciseQueue.length}`;

        // enable/disable buttons accordingly
        prevButton.disabled = currentExerciseIndex === 0;
        nextButton.disabled = currentExerciseIndex === exerciseQueue.length - 1;
      }

      // show or hide the previous/next buttons and progress
      function showNavigationControls(show) {
        const display = show ? 'inline-block' : 'none';
        prevButton.style.display = display;
        nextButton.style.display = display;
        progressText.style.display = display;
      }

      /********************************************
       * STEP LIST RENDERING
       *******************************************/
      function renderSteps() {
        const list = document.getElementById('exerciseStepsList');
        list.innerHTML = '';
        if (!state.steps.length) {
          list.innerHTML = '<li>No steps available.</li>';
          return;
        }
        state.steps.forEach((step, idx) => {
          const li = document.createElement('li');
          li.textContent = step;
          if (idx === state.currentStep) {
            li.style.fontWeight = 'bold';
            li.style.color = '#007bff';
            li.style.background = '#e6f3ff';
          }
          list.appendChild(li);
        });
        setText('currentStepDisplay', state.steps[state.currentStep] ?? 'N/A');
      }

      /********************************************
       * READ STEPS
       *******************************************/
      let voices = [];
      let utterance;
      let isSpeaking = false;
    
      function loadVoices() {
        voices = speechSynthesis.getVoices()
          .filter(voice => voice.lang.toLowerCase().startsWith('en'));
      
        const voiceSelect = document.getElementById('voiceSelect');
        voiceSelect.innerHTML = '';
      
        voices.forEach((voice, i) => {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `${voice.name} (${voice.lang})`;
          voiceSelect.appendChild(option);
        });
      }      
    
      window.speechSynthesis.onvoiceschanged = loadVoices;
    
      function readSteps() {
        const stepsList = document.getElementById('exerciseStepsList');
        const voiceSelect = document.getElementById('voiceSelect');
        const rate = parseFloat(document.getElementById('rateSlider').value);
    
        if (!stepsList || !voiceSelect) return;
    
        const steps = Array.from(stepsList.querySelectorAll('li'))
          .map(li => li.textContent)
          .join('. ');
    
        if (!steps.trim()) {
          alert("No steps available to read.");
          return;
        }
    
        if (speechSynthesis.speaking) {
          speechSynthesis.cancel(); // cancel ongoing speech
        }
    
        utterance = new SpeechSynthesisUtterance(steps);
        const selectedVoice = voices[voiceSelect.value];
        if (selectedVoice) {
          utterance.voice = selectedVoice;
        }
    
        utterance.lang = 'en-US';
        utterance.rate = rate;
    
        speechSynthesis.speak(utterance);
        isSpeaking = true;
      }
    
      function pauseSpeech() {
        if (speechSynthesis.speaking && !speechSynthesis.paused) {
          speechSynthesis.pause();
        }
      }
    
      function resumeSpeech() {
        if (speechSynthesis.paused) {
          speechSynthesis.resume();
        }
      }
    
      function stopSpeech() {
        speechSynthesis.cancel();
        isSpeaking = false;
      }
    
      // Update slider values on screen
      document.getElementById('rateSlider').addEventListener('input', () => {
        document.getElementById('rateValue').textContent = document.getElementById('rateSlider').value;
      });
    
      // Event listeners
      document.getElementById('readStepsButton').addEventListener('click', readSteps);
      document.getElementById('pauseButton').addEventListener('click', pauseSpeech);
      document.getElementById('resumeButton').addEventListener('click', resumeSpeech);
      document.getElementById('stopButton').addEventListener('click', stopSpeech);

       
      /******************************
       *       UPLOAD VIDEO 
       ****************************/
      document.getElementById('uploadVideoButton').addEventListener('click', () => {
        document.getElementById('videoFileInput').click();
      });

      // when file has been selected
      document.getElementById('videoFileInput').addEventListener('change', (e) => {
        const statusEl = document.getElementById('videoUploadStatus');

        if (e.target.files.length > 0) {
          const fileName = e.target.files[0].name;
          const videoFile = e.target.files[0];

          console.log('File selected:', fileName);

          // show analyze video button
          document.getElementById('analyzeVideoButton').classList.remove('hidden');
      
          // show success message
          statusEl.innerHTML = `<span style="color: green;"><strong>${fileName}</strong> uploaded successfully!</span>`;
          
          // show uploaded video immediately 
          const container = document.getElementById('video-analysis-container');
          const analysisVideo = document.getElementById('analysis-video');
          const analysisContent = document.getElementById('analysis-content');
      
          const videoURL = URL.createObjectURL(videoFile);
          analysisVideo.src = videoURL;
      
          // clear any previous analysis feedback
          container.classList.add('show');
          analysisContent.innerHTML = '<em>Video uploaded. Click "Analyze Video" to get feedback.</em>';
        
        } else {
          statusEl.textContent = '';
        }
      });

      /** ANALYZE VIDEO **/
      document.getElementById('analyzeVideoButton').addEventListener('click', analyzeVideo)

      // max video size
      const MAX_FILE_SIZE_BYTES = 45 * 1024 * 1024; // 45 MB

      async function analyzeVideo() {
        console.log('analyzeVideo function called');
        const videoFileInput = document.getElementById('videoFileInput');
        const videoFile = videoFileInput.files[0];

        // Hide feedback section initially and clear any previous error messages
        document.getElementById('feedbackSection').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';

        if (!videoFile) {
          showError("Please select a video file first.");
          return;
        }

        if (videoFile.size > MAX_FILE_SIZE_BYTES) {
          showError(`File is too large. Max allowed is ~${Math.round(MAX_FILE_SIZE_BYTES / (1024 * 1024))}MB.`);
          return;
        }

        // Show the video analysis container
        const container = document.getElementById('video-analysis-container');
        const analysisContent = document.getElementById('analysis-content');
        // Show container and reset feedback content
        container.classList.add('show');
        analysisContent.innerHTML = '<span class="analyzing-spinner">‚ü≥</span> Analyzing video...';

        try {
          // Read the file as Base64
          const base64Data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(videoFile);
          });

          let requestData = {
            videoData: {
              base64: base64Data,
              mimeType: videoFile.type,
              fileName: videoFile.name
            }
          };

          console.log('Sending request data:', requestData);

          // Send to app.py
          const response = await fetch('/analyze_video', {
            method: "POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            // Display the feedback in the analysis container
            analysisContent.innerHTML = `<div style="white-space: pre-wrap;">${data.feedback}</div>`;
          } else {
            analysisContent.innerHTML = `<div style="color: #dc3545;">‚ùå ${data.error || 'Analysis failed. Please try again.'}</div>`;
          }
        } catch (error) {
          console.error('Error:', error);
          analysisContent.innerHTML = `<div style="color: #dc3545;">‚ùå Network error. Please check your connection and try again.</div>`;
        } 
      

      }

      /********************************************
       * WEBCAM MANAGEMENT
       *******************************************/
      document.getElementById('startExerciseButton').addEventListener('click', startExercise);
      document.getElementById('nextStepButton').addEventListener('click', nextStep);
      document.getElementById('finishExerciseButton').addEventListener('click', finishExercise);
      document.getElementById('stopWebcamButton').addEventListener('click', stopWebcam);

      async function startWebcam() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('Webcam API is not supported in this browser.');
          return false;
        }
        try {
          state.stream = await navigator.mediaDevices.getUserMedia({ video: true });
          const vid = document.getElementById('videoElement');
          vid.srcObject = state.stream;
          vid.play();
          toggle('webcam-container', false);
          return true;
        } catch (err) {
          console.error('Webcam error:', err);
          alert('Failed to access webcam (permission denied or no device).');
          return false;
        }
      }

      function stopWebcam() {
        if (state.stream) {
          state.stream.getTracks().forEach((t) => t.stop());
          document.getElementById('videoElement').srcObject = null;
          state.stream = null;
        }
        stopFrameProcessing();
        toggle('webcam-container', true);
        fetch('/stop_webcam', { method: 'POST' }).catch(() => {});
      }

      /********************************************
       * EXERCISE FLOW
       *******************************************/
      async function startExercise() {
        if (!state.steps.length) return alert('Get an exercise recommendation first.');

        const ok = await startWebcam();
        if (!ok) return;

        toggle('startExerciseButton', true);
        toggle('nextStepButton', false);
        toggle('finishExerciseButton', false);

        state.currentStep = 0;
        renderSteps();
        setText('vlmFeedbackOutput', 'Analyzing your pose...');
        setText('vlmStatusOutput', 'In Progress');

        if (!state.processingFrames) {
          state.frameIntervalId = setInterval(sendFrameToVLM, 1000);
          state.processingFrames = true;
        }
      }

      async function sendFrameToVLM() {
        if (!state.stream) return;

        const vid = document.getElementById('videoElement');
        const canvas = document.createElement('canvas');
        canvas.width = vid.videoWidth;
        canvas.height = vid.videoHeight;
        canvas.getContext('2d').drawImage(vid, 0, 0);
        const b64 = canvas.toDataURL('image/jpeg', 0.8);

        try {
          const res = await fetch('/process_frame', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: b64 }),
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);

          setText('vlmFeedbackOutput', data.feedback ?? '');
          setText('vlmStatusOutput', data.status ?? '');
          setText('currentStepDisplay', data.next_step ?? '');

          if (data.status === 'Completed') {
            state.currentStep = data.is_last_step ? state.steps.length - 1 : state.currentStep + 1;
            renderSteps();

            if (data.is_last_step) {
              finishExercise();
              alert('Great job! You completed the exercise.');
            } else {
              setText('vlmFeedbackOutput', 'Move to the next step...');
            }
          }
        } catch (err) {
          console.error(err);
          setText('vlmFeedbackOutput', 'VLM error or network issue.');
          stopFrameProcessing();
        }
      }

      function nextStep() {
        if (state.currentStep < state.steps.length - 1) {
          state.currentStep++;
          renderSteps();
          setText('vlmFeedbackOutput', 'Analyzing...');
        } else {
          alert('You are on the last step.');
          finishExercise();
        }
      }

      function finishExercise() {
        stopFrameProcessing();
        stopWebcam();
        toggle('startExerciseButton', false);
        toggle('nextStepButton', true);
        toggle('finishExerciseButton', true);
        setText('vlmFeedbackOutput', 'Exercise session ended.');
        setText('vlmStatusOutput', 'Finished');
        setText('currentStepDisplay', 'N/A');
      }

      /********************************************
       * FRAME PROCESSING CONTROL
       *******************************************/
      function stopFrameProcessing() {
        if (state.frameIntervalId) {
          clearInterval(state.frameIntervalId);
          state.frameIntervalId = null;
          state.processingFrames = false;
        }
      }


      /********************************************
       * UPLOAD FUNCTIONALITY (INLINE)
       *******************************************/

       document.addEventListener('DOMContentLoaded', () => {
        
        let uploadedFileName = null;
        
        document.getElementById('inlinePdfFileInput').addEventListener('change', function () {
          const fileNameDisplay = document.getElementById('inlineFileNameDisplay');
          if (this.files.length > 0) {
            fileNameDisplay.textContent = this.files[0].name;
            uploadPdfFile(this.files[0]);
          } else {
            fileNameDisplay.textContent = 'No file chosen';
          }
        });

        async function uploadPdfFile(file) {
          const uploadStatus = document.getElementById('inlineUploadStatus');
          uploadStatus.textContent = 'Uploading...';
          uploadStatus.style.color = '#007bff';

          const formData = new FormData();
          formData.append('pdf_file', file);

          try {
            const response = await fetch('/upload_pdf', {
              method: 'POST',
              body: formData
            });

            const data = await response.json();

            if (response.ok) {
              uploadedFileName = data.filename;
              console.log("Upload successful, stored filename:", uploadedFileName);
              uploadStatus.textContent = data.message || 'File uploaded successfully!';
              uploadStatus.style.color = '#28a745';
            } else {
              uploadStatus.textContent = data.error || 'Error uploading file.';
              uploadStatus.style.color = '#dc3545';
            }
          } catch (error) {
            console.error('Upload error:', error);
            uploadStatus.textContent = 'Network error or server unreachable.';
            uploadStatus.style.color = '#dc3545';
          }
        }

        document.getElementById('cancelUploadBtn').addEventListener('click', async function () {
          console.log("Cancel Upload clicked"); // üîç Confirm this fires

          document.getElementById('inlinePdfFileInput').value = "";
          document.getElementById('inlineFileNameDisplay').textContent = 'No file chosen';
          document.getElementById('inlineUploadStatus').textContent = '';

          const user_prosthetic = document.getElementById('prostheticInput').value;

          if (uploadedFileName) {
            console.log("Attempting to remove:", uploadedFileName);
            try {
              const res = await fetch('/remove_pdf', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  filename: uploadedFileName,
                  user_prosthetic: user_prosthetic
                })
              });
              const data = await res.json();
              alert(data.message || data.error);
              uploadedFileName = null;
            } catch (error) {
              console.error('Error removing file:', error);
            }
          } else {
            console.log("No uploaded file to remove.");
          }
        });
      });

      /********************************************
       * UTILS
       *******************************************/
      function setText(id, text) {
        document.getElementById(id).textContent = text;
      }
      function toggle(id, hidden) {
        document.getElementById(id).classList[hidden ? 'add' : 'remove']('hidden');
      }
      function resetUI() {
        stopWebcam();
        stopFrameProcessing();
        toggle('startExerciseButton', true);
        toggle('nextStepButton', true);
        toggle('finishExerciseButton', true);
        setText('currentStepDisplay', 'N/A');
        setText('vlmFeedbackOutput', 'Awaiting feedback...');
        setText('vlmStatusOutput', 'Idle');
        document.getElementById('exerciseStepsList').innerHTML = '<li>Loading steps...</li>';
      }

      function showFeedback(feedback) {
        const feedbackSection = document.getElementById('feedbackSection');
        const feedbackContent = document.getElementById('feedbackContent');
        
        feedbackContent.textContent = feedback;
        feedbackSection.style.display = 'block';  // Only show after successful analysis
      }

      function showError(message) {
        const errorElement = document.getElementById('errorMessage');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }

      /********************************************
       * INIT
       *******************************************/
      document.addEventListener('DOMContentLoaded', () => {
        // open default tab
        switchTab('symptomsTab', document.querySelector('.tab-button'));
      });
    </script>
  </body>
</html>
